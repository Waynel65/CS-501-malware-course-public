import datetime
import time
import json
import types
import pefile


# date_time = datetime.datetime(2022,2,21,21,43,16)
# print("unix_timestamp => ",
#       (time.mktime(date_time.timetuple())))

def get_imphash(filepath):
    pe = pefile.PE(filepath)
    imphash = pe.get_imphash()

    pe_import_dict = {}
    # walk the Imports
    for entry in pe.DIRECTORY_ENTRY_IMPORT:
        dll_name = entry.dll.decode('utf-8')
        pe_import_dict[dll_name] = []
        for func in entry.imports:
            pe_import_dict[dll_name] += [func.name.decode('utf-8')]

		
    return imphash, pe_import_dict

imphash, pe_import_dict = get_imphash("stage2.exe")
print(imphash)
print(json.dumps(pe_import_dict, indent=4, sort_keys=True))

def parse_stack_strings(filepath):
    with open(filepath) as f:
        lines = f.readlines()
    # print(lines)
    result = ""
    for i in range(len(lines)):
        s = lines[i]
        new_s = s.split('=')
        lines[i] = new_s[1]
        # print(lines[i])
        lines[i] = lines[i].strip()
        # print(lines[i].split(';'))
        lines[i] = lines[i].split(';')[0]
        
        if "\'" in lines[i]:
            result += (lines[i])
        else:
            # lines[i] = hex(lines[i])
            line_in_hex = (int(lines[i],16))
            if line_in_hex == 153 or line_in_hex == 0:
                result += chr(int(lines[i]))
                print(int(lines[i]))
            result += chr(line_in_hex)

    # print(lines)
    return result

# result = parse_stack_strings("freecandy_stack_str.txt")
# print(result)
# print("\'" in "'U'")
# print(int('0x74', 16))
# result = ''