import os
from ctypes import create_string_buffer
import sys 


def get_cstring(b):
    s = ""
    hex_b = b.hex()
    for i in range(len(hex_b)//2):
        s += f"\\x{hex_b[i * 2: i* 2 + 2]}"
    return f'"{s}"'

def xor_bytes(b0, b1):
    return bytes([i ^ j for i,j in zip(b0, b1)])



class EncryptedString:
    def __init__(self, data, max_size = 1000):
        # this wll just add a null byte to the string 
        self.data = create_string_buffer(data).raw
        self.key = os.urandom(len(self.data))
        self.ciphertext = xor_bytes(self.data, self.key)

    def getLiteral(self):
         
        #char buffer[5];auto z = xorString(buffer, x,y,5);
        literal_data = get_cstring(self.ciphertext)
        literal_key = get_cstring(self.key)
        l = len(self.data)
        ret = f"xorString({literal_data},{literal_key},{l})"
        return ret



def parse_header(header):
    new_config = []
    with open(header) as f:
        for line in f:
            if "#define" in line:
                try:
                    define, var, literal = line.split(" ")
                    es = EncryptedString(literal.encode("utf-8"))
                    new_config += [[define, var, es.getLiteral() ]]

                except Exception as e:
                    print(Exception, e)
                    continue
            
    header = ""
    for l in new_config:
        header += " ".join(l) + "\n"
    return header

if __name__ == "__main__":

    print("OK")
    header_in = sys.argv[1]
    header_out = sys.argv[2]
    enc_str = parse_header(header_in)

    with open(header_out, "w+") as f:
        f.write(enc_str)
        print(f"[+] Wrote {header_out}")
 