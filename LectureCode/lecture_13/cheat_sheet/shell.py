from subprocess import PIPE, Popen
import threading, queue
import time 


def run_shell():
    p =  Popen(["powershell.exe"], shell=True,  stderr=PIPE, stdin=PIPE, stdout=PIPE)
    return p

p = run_shell()
q = queue.Queue()

def reader():
    print("q reader")
    while p.poll() == None:
        if q.empty():
            time.sleep(2)
        else:
            print(q.get(), end="")
    print("Goodbye")

#def write_worker():

def read_worker():
    print("Reader")
    while p.poll() == None:
        time.sleep(1)
        len_x = p.stdout.peek(1)
        if len_x != None:
            len_x = len(len_x)
        data = p.stdout.read(len_x)
        if data != None:
            data = data.decode()
        else:
            continue
        q.put(data)
        print("added data", data)
    print("Goodbye2")

def exec_command(cmd):
    p.stdin.write(f"{cmd}\r\n".encode())
    p.stdin.flush()


threading.Thread(target=read_worker, daemon=True).start()
threading.Thread(target=reader, daemon=True).start()

exec_command("whoami")



